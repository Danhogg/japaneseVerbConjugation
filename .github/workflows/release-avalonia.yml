name: Build and Release (Avalonia)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch, tag, or commit to build (e.g. main)"
        required: false
        default: "main"
        type: string
      version:
        description: "Optional version override (e.g. 2.0.1)"
        required: false
        type: string
      create_release:
        description: "Create/overwrite GitHub Release"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
          - os: macos-latest
            rid: osx-x64
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout workflow branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout tag commit (push tag)
        if: github.event_name == 'push'
        shell: pwsh
        run: |
          git fetch --force --tags
          git checkout --force "$env:GITHUB_REF"
          Write-Host "Checked out $env:GITHUB_REF @ $(git rev-parse HEAD)" -ForegroundColor Green
          git describe --tags --exact-match

      - name: Checkout ref (manual)
        if: github.event_name == 'workflow_dispatch'
        shell: pwsh
        run: |
          $ref = "${{ inputs.ref }}".Trim()
          if ([string]::IsNullOrWhiteSpace($ref)) { $ref = "main" }
          $isTag = $ref.StartsWith("v")
          git fetch --force --tags
          if ($isTag) {
            git checkout --force "refs/tags/$ref"
            Write-Host "Checked out refs/tags/$ref @ $(git rev-parse HEAD)" -ForegroundColor Green
          } else {
            git checkout --force "$ref"
            Write-Host "Checked out $ref @ $(git rev-parse HEAD)" -ForegroundColor Green
          }

      - name: Compute version + output names
        id: meta
        shell: pwsh
        run: |
          $isManual = "${{ github.event_name }}" -eq "workflow_dispatch"
          $version = "${{ inputs.version }}".Trim()
          if (-not $isManual) {
            $tag = "${{ github.ref_name }}"
            $version = $tag -replace '^v', ''
          } elseif ([string]::IsNullOrWhiteSpace($version)) {
            $vp = (dotnet msbuild JapaneseVerbConjugation.AvaloniaUI/JapaneseVerbConjugation.AvaloniaUI.csproj -getProperty:VersionPrefix -nologo | Where-Object { $_ -and $_.Trim() }) | Select-Object -Last 1
            $version = $vp.Trim()
          }
          $rid = "${{ matrix.rid }}"
          $outDir = "JapaneseConjugationTraining-Avalonia-v$version-$rid"
          $zip = "$outDir.zip"

          "tag=${{ github.ref_name }}" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "outDir=$outDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "zip=$zip" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore JapaneseVerbConjugation.AvaloniaUI/JapaneseVerbConjugation.AvaloniaUI.csproj

      - name: Run tests (Windows only)
        if: matrix.os == 'windows-latest'
        run: dotnet test japaneseVerbConjugationTests/japaneseVerbConjugationTests.csproj -c Release

      - name: Publish (Release, self-contained)
        shell: pwsh
        run: |
          $outDir = "${{ steps.meta.outputs.outDir }}"
          $rid = "${{ matrix.rid }}"

          dotnet publish JapaneseVerbConjugation.AvaloniaUI/JapaneseVerbConjugation.AvaloniaUI.csproj `
            -c Release `
            -r $rid `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:EnableCompressionInSingleFile=true `
            -o $outDir

      - name: Copy data files
        shell: pwsh
        run: |
          $outDir = "${{ steps.meta.outputs.outDir }}"
          $dataDir = Join-Path $outDir "Data"
          New-Item -ItemType Directory -Force -Path $dataDir | Out-Null

          $src = "JapaneseVerbConjugation.Core\Data"
          $files = @("N5.csv", "N4.csv", "jmdict-eng-3.6.1.json.gz")
          foreach ($f in $files) {
            $from = Join-Path $src $f
            $to = Join-Path $dataDir $f
            if (Test-Path $from) {
              Copy-Item $from $to -Force
              Write-Host "Copied $f" -ForegroundColor Gray
            } else {
              Write-Host "Warning: missing $from" -ForegroundColor Yellow
            }
          }

      - name: Create ZIP
        shell: pwsh
        run: |
          $outDir = "${{ steps.meta.outputs.outDir }}"
          $zip = "${{ steps.meta.outputs.zip }}"

          if (Test-Path $zip) { Remove-Item $zip -Force }

          Add-Type -AssemblyName System.IO.Compression.FileSystem
          [System.IO.Compression.ZipFile]::CreateFromDirectory(
            (Resolve-Path $outDir).Path,
            (Join-Path (Get-Location) $zip),
            [System.IO.Compression.CompressionLevel]::Optimal,
            $false
          )

          $size = [math]::Round((Get-Item $zip).Length / 1MB, 2)
          Write-Host "ZIP created: $zip ($size MB)" -ForegroundColor Green

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.zip }}
          path: ${{ steps.meta.outputs.zip }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || inputs.create_release == 'true'
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: ls -la artifacts

      - name: Create/Update GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }} (Avalonia)
          files: artifacts/**/*.zip
          draft: false
          prerelease: false
          overwrite: true
          body: |
            ## Japanese Verb Conjugation Training (Avalonia)

            ### Downloads
            - Windows: `*-win-x64.zip`
            - Linux: `*-linux-x64.zip`
            - macOS: `*-osx-x64.zip`

            ### Notes
            Extract and run the executable inside each ZIP. The `Data` folder is included.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
