name: Build and Release (Avalonia)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to build (e.g. v1.3.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
          - os: ubuntu-latest
            rid: linux-x64
          - os: macos-latest
            rid: osx-x64
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout workflow branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout tag commit (push tag)
        if: github.event_name == 'push'
        shell: pwsh
        run: |
          git fetch --force --tags
          git checkout --force "$env:GITHUB_REF"
          Write-Host "Checked out $env:GITHUB_REF @ $(git rev-parse HEAD)" -ForegroundColor Green
          git describe --tags --exact-match

      - name: Checkout tag commit (manual)
        if: github.event_name == 'workflow_dispatch'
        shell: pwsh
        run: |
          $tag = "${{ inputs.tag }}".Trim()
          if (-not $tag.StartsWith("v")) { throw "Tag must start with 'v' (e.g. v1.3.0). You entered '$tag'." }
          git fetch --force --tags
          git rev-parse "refs/tags/$tag" | Out-Null
          git checkout --force "refs/tags/$tag"
          Write-Host "Checked out refs/tags/$tag @ $(git rev-parse HEAD)" -ForegroundColor Green
          git describe --tags --exact-match

      - name: Compute version + output names
        id: meta
        shell: pwsh
        run: |
          $tag = if ("${{ github.event_name }}" -eq "workflow_dispatch") { "${{ inputs.tag }}" } else { "${{ github.ref_name }}" }
          $version = $tag -replace '^v', ''
          $rid = "${{ matrix.rid }}"
          $outDir = "JapaneseConjugationTraining-Avalonia-v$version-$rid"
          $zip = "$outDir.zip"

          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "outDir=$outDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "zip=$zip" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore japaneseVerbConjugation.sln

      - name: Publish (Release, self-contained)
        shell: pwsh
        run: |
          $outDir = "${{ steps.meta.outputs.outDir }}"
          $rid = "${{ matrix.rid }}"

          dotnet publish JapaneseVerbConjugation.AvaloniaUI/JapaneseVerbConjugation.AvaloniaUI.csproj `
            -c Release `
            -r $rid `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:EnableCompressionInSingleFile=true `
            -o $outDir

      - name: Copy CSV data files
        shell: pwsh
        run: |
          $outDir = "${{ steps.meta.outputs.outDir }}"
          $dataDir = Join-Path $outDir "Data"
          New-Item -ItemType Directory -Force -Path $dataDir | Out-Null

          $src = "JapaneseVerbConjugation.Core\Data"
          $files = @("N5.csv", "N4.csv")
          foreach ($f in $files) {
            $from = Join-Path $src $f
            $to = Join-Path $dataDir $f
            if (Test-Path $from) {
              Copy-Item $from $to -Force
              Write-Host "Copied $f" -ForegroundColor Gray
            } else {
              Write-Host "Warning: missing $from" -ForegroundColor Yellow
            }
          }

      - name: Create ZIP
        shell: pwsh
        run: |
          $outDir = "${{ steps.meta.outputs.outDir }}"
          $zip = "${{ steps.meta.outputs.zip }}"

          if (Test-Path $zip) { Remove-Item $zip -Force }

          Add-Type -AssemblyName System.IO.Compression.FileSystem
          [System.IO.Compression.ZipFile]::CreateFromDirectory(
            (Resolve-Path $outDir).Path,
            (Join-Path (Get-Location) $zip),
            [System.IO.Compression.CompressionLevel]::Optimal,
            $false
          )

          $size = [math]::Round((Get-Item $zip).Length / 1MB, 2)
          Write-Host "ZIP created: $zip ($size MB)" -ForegroundColor Green

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.zip }}
          path: ${{ steps.meta.outputs.zip }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: ls -la artifacts

      - name: Create/Update GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
          name: Release ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }} (Avalonia)
          files: artifacts/**/*.zip
          draft: false
          prerelease: false
          overwrite: true
          body: |
            ## Japanese Verb Conjugation Training (Avalonia)

            ### Downloads
            - Windows: `*-win-x64.zip`
            - Linux: `*-linux-x64.zip`
            - macOS: `*-osx-x64.zip`

            ### Notes
            Extract and run the executable inside each ZIP. The `Data` folder is included.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
