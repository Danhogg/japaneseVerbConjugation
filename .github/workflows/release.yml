name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.1.0, v2.0.0, etc.
    paths:
      - '.github/workflows/release.yml'  # Re-run when workflow file changes
  workflow_dispatch:  # Allows manual triggering from GitHub Actions UI

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Build and Create Release
      shell: pwsh
      run: |
        # Run the build script
        .\build-release.ps1
        
        # Get the version from the tag (remove 'v' prefix)
        $version = "${{ github.ref_name }}" -replace '^v', ''
        $zipFile = "JapaneseConjugationTraining-v$version.zip"
        
        # Verify ZIP exists
        if (-not (Test-Path $zipFile)) {
          Write-Error "ZIP file not found: $zipFile"
          exit 1
        }
        
        # Display file info
        $zipSize = [math]::Round((Get-Item $zipFile).Length / 1MB, 2)
        Write-Host "Release package: $zipFile ($zipSize MB)" -ForegroundColor Green
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        files: |
          JapaneseConjugationTraining-v*.zip
        draft: false
        prerelease: false
        overwrite: true
        body: |
          ## Japanese Verb Conjugation Training ${{ github.ref_name }}
          
          ### Download
          Download the ZIP file above and extract it. Run `JapaneseVerbConjugation.exe` to start the application.
          
          ### Installation
          1. Download the ZIP file
          2. Extract to a folder
          3. Run `JapaneseVerbConjugation.exe`
          4. No installation required - it's a self-contained application!
          
          ### Requirements
          - Windows 10/11 (64-bit)
          - No .NET installation needed (included in the package)
          
          ### What's Included
          - Japanese Verb Conjugation application
          - Japanese dictionary (JMdict)
          - Sample verb lists (N5, N4)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
