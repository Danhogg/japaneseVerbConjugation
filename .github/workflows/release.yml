name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build (must start with v, e.g. v1.1.0)"
        required: true
        type: string

permissions:
  contents: write  # required for creating a GitHub Release with GITHUB_TOKEN

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout (tag push)
        if: github.event_name == 'push'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout (manual tag)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.tag }}

      - name: Validate manual tag
        if: github.event_name == 'workflow_dispatch'
        shell: pwsh
        run: |
          if (-not "${{ inputs.tag }}".StartsWith("v")) {
            Write-Error "Input tag must start with 'v' (example: v1.1.0)."
            exit 1
          }

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # Single source of truth: the script creates the ZIP
      - name: Build package (script)
        shell: pwsh
        run: .\build-release.ps1

      - name: Verify ZIP exists
        shell: pwsh
        run: |
          $tag = if ("${{ github.event_name }}" -eq "workflow_dispatch") { "${{ inputs.tag }}" } else { "${{ github.ref_name }}" }
          $version = $tag -replace '^v', ''
          $zipFile = "JapaneseConjugationTraining-v$version.zip"

          if (-not (Test-Path $zipFile)) {
            Write-Error "ZIP file not found: $zipFile"
            Write-Host "Found ZIP files:" -ForegroundColor Yellow
            Get-ChildItem -Filter "JapaneseConjugationTraining-v*.zip" | Select-Object Name, Length
            exit 1
          }

          $zipSize = [math]::Round((Get-Item $zipFile).Length / 1MB, 2)
          Write-Host "Release package: $zipFile ($zipSize MB)" -ForegroundColor Green

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
          name: Release ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
          files: JapaneseConjugationTraining-v*.zip
          draft: false
          prerelease: false
          overwrite: true
          body: |
            ## Japanese Verb Conjugation Training

            ### Download
            Download the ZIP file above and extract it. Run `JapaneseVerbConjugation.exe` to start the application.

            ### Installation
            1. Download the ZIP file
            2. Extract to a folder
            3. Run `JapaneseVerbConjugation.exe`

            ### Requirements
            - Windows 10/11 (64-bit)
            - No .NET installation needed (included in the package)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
