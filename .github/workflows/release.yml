name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to build (e.g. v1.1.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout (tag push)
        if: github.event_name == 'push'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ github.ref }} # refs/tags/v1.1.0

      - name: Checkout (manual tag)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: refs/tags/${{ inputs.tag }}

      - name: Validate manual tag exists
        if: github.event_name == 'workflow_dispatch'
        shell: pwsh
        run: |
          $tag = "${{ inputs.tag }}"
          if (-not $tag.StartsWith("v")) {
            throw "Tag must start with 'v' (example: v1.1.0)."
          }
          git fetch --tags --force
          git rev-parse "refs/tags/$tag" | Out-Null
          Write-Host "Checked out tag $tag at commit $(git rev-parse HEAD)" -ForegroundColor Green

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Build package (script)
        shell: pwsh
        run: .\build-release.ps1

      - name: Verify ZIP exists
        shell: pwsh
        run: |
          $tag = if ("${{ github.event_name }}" -eq "workflow_dispatch") { "${{ inputs.tag }}" } else { "${{ github.ref_name }}" }
          $version = $tag -replace '^v', ''
          $zipFile = "JapaneseConjugationTraining-v$version.zip"

          if (-not (Test-Path $zipFile)) {
            Write-Host "Found ZIP files:" -ForegroundColor Yellow
            Get-ChildItem -Filter "JapaneseConjugationTraining-v*.zip" | Select-Object Name, Length
            throw "ZIP file not found: $zipFile"
          }

          Write-Host "Release ZIP ok: $zipFile" -ForegroundColor Green

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
          name: Release ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
          files: JapaneseConjugationTraining-v*.zip
          draft: false
          prerelease: false
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}