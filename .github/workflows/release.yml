name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to build (e.g. v1.1.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout workflow branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Always force the repo to the tag commit before building
      - name: Checkout tag commit (push tag)
        if: github.event_name == 'push'
        shell: pwsh
        run: |
          git fetch --force --tags
          git checkout --force "$env:GITHUB_REF"
          Write-Host "Checked out $env:GITHUB_REF @ $(git rev-parse HEAD)" -ForegroundColor Green
          git describe --tags --exact-match

      - name: Checkout tag commit (manual)
        if: github.event_name == 'workflow_dispatch'
        shell: pwsh
        run: |
          $tag = "${{ inputs.tag }}".Trim()
          if (-not $tag.StartsWith("v")) { throw "Tag must start with 'v' (e.g. v1.1.0). You entered '$tag'." }

          git fetch --force --tags
          git rev-parse "refs/tags/$tag" | Out-Null
          git checkout --force "refs/tags/$tag"

          Write-Host "Checked out refs/tags/$tag @ $(git rev-parse HEAD)" -ForegroundColor Green
          git describe --tags --exact-match

      - name: Compute version + output names
        id: meta
        shell: pwsh
        run: |
          $tag = if ("${{ github.event_name }}" -eq "workflow_dispatch") { "${{ inputs.tag }}" } else { "${{ github.ref_name }}" }
          $version = $tag -replace '^v', ''
          $outDir = "JapaneseConjugationTraining-v$version"
          $zip = "$outDir.zip"

          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "outDir=$outDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "zip=$zip" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore japaneseVerbConjugation.sln

      - name: Test (Release)
        run: dotnet test japaneseVerbConjugationTests/japaneseVerbConjugationTests.csproj -c Release --verbosity normal

      - name: Publish (Release, self-contained win-x64)
        shell: pwsh
        run: |
          $outDir = "${{ steps.meta.outputs.outDir }}"

          dotnet publish japaneseVerbConjugation/JapaneseVerbConjugation.csproj `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:EnableCompressionInSingleFile=true `
            -o $outDir

      - name: Copy Data files
        shell: pwsh
        run: |
          $outDir = "${{ steps.meta.outputs.outDir }}"
          $dataDir = Join-Path $outDir "Data"
          New-Item -ItemType Directory -Force -Path $dataDir | Out-Null

          $src = "japaneseVerbConjugation\Data"
          $files = @(
            "jmdict-eng-3.6.1.json.gz",
            "N5.csv",
            "N4.csv"
          )

          foreach ($f in $files) {
            $from = Join-Path $src $f
            $to = Join-Path $dataDir $f

            if (Test-Path $from) {
              Copy-Item $from $to -Force
              Write-Host "Copied $f" -ForegroundColor Gray
            } else {
              Write-Host "Warning: missing $from" -ForegroundColor Yellow
            }
          }

      - name: Remove PDBs (optional)
        shell: pwsh
        run: |
          $outDir = "${{ steps.meta.outputs.outDir }}"
          Get-ChildItem -Path $outDir -Filter "*.pdb" -Recurse -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue

      - name: Create ZIP
        shell: pwsh
        run: |
          $outDir = "${{ steps.meta.outputs.outDir }}"
          $zip = "${{ steps.meta.outputs.zip }}"

          if (Test-Path $zip) { Remove-Item $zip -Force }

          Add-Type -AssemblyName System.IO.Compression.FileSystem
          [System.IO.Compression.ZipFile]::CreateFromDirectory(
            (Resolve-Path $outDir).Path,
            (Join-Path (Get-Location) $zip),
            [System.IO.Compression.CompressionLevel]::Optimal,
            $false
          )

          $size = [math]::Round((Get-Item $zip).Length / 1MB, 2)
          Write-Host "ZIP created: $zip ($size MB)" -ForegroundColor Green

      - name: Create/Update GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: Release ${{ steps.meta.outputs.tag }}
          files: ${{ steps.meta.outputs.zip }}
          draft: false
          prerelease: false
          overwrite: true
          body: |
            ## Japanese Verb Conjugation Training ${{ steps.meta.outputs.tag }}

            ### Download
            Download the ZIP file above and extract it. Run `JapaneseVerbConjugation.exe` to start the application.

            ### Requirements
            - Windows 10/11 (64-bit)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
